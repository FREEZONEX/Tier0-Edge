UNS å·¥ä¸šç‰©è”ç½‘å‰ç«¯é¡¹ç›®éœ€æ±‚æ–‡æ¡£ (PRD)

1. é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®æ—¨åœ¨æ„å»ºä¸€ä¸ªåŸºäº Unified Namespace (UNS) ç†å¿µçš„å·¥ä¸šç‰©è”ç½‘å‰ç«¯åº”ç”¨ã€‚ç³»ç»Ÿä¸»è¦åŒ…å«æ•°æ®ç›‘æ§çœ‹æ¿å’Œç”Ÿäº§æŠ¥å·¥å½•å…¥ä¸¤ä¸ªæ ¸å¿ƒæ¨¡å—ã€‚
åç«¯é€»è¾‘ç”± Node-RED æ‰¿è½½ï¼Œæ•°æ®é€šä¿¡å®Œå…¨åŸºäº MQTT åè®®ï¼ˆEMQX Brokerï¼‰ï¼Œå‰ç«¯éœ€æ”¯æŒå®¹å™¨åŒ–éƒ¨ç½²å¹¶é€šè¿‡ Gitea Actions å®ç°è‡ªåŠ¨åŒ–æ„å»ºã€‚

2. ç³»ç»Ÿæ¶æ„ä¸æŠ€æœ¯æ ˆ

2.1 æ¶æ„å›¾ç¤º

å‰ç«¯: React (æ¨è stack: Vite + React + TypeScript + TailwindCSS)

æ¶ˆæ¯æ€»çº¿: MQTT Broker (EMQX @ emqx:1883)

ä¸šåŠ¡é€»è¾‘: Node-RED (è´Ÿè´£è§£æ JSON æ¨¡æ¿ã€æµè½¬æ•°æ®)

ç½‘å…³/è½¬å‘: Kong (å‰ç«¯éœ€æ”¯æŒ BaseURL é…ç½®ä»¥é€‚é…ç½‘å…³è½¬å‘)

éƒ¨ç½²: Docker + Gitea Actions

2.2 æ ¸å¿ƒç†å¿µ (UNS)

æ•°æ®ç»“æ„ä¸¥æ ¼éµå¾ª ISA-95 å±‚çº§ç»“æ„ï¼ŒTopic å®šä¹‰å¦‚ä¸‹ï¼š
v1/<Enterprise>/<Site>/<Area>/<Line>/<Cell>/<Device>/<Namespace>/<Topic>

æ•°æ®ç±»å‹å®šä¹‰ï¼š

State (çŠ¶æ€): jsonb æ ¼å¼ï¼Œç”¨äºæè¿°è®¾å¤‡æˆ–ä»»åŠ¡çš„å½“å‰å±æ€§ (å¦‚: current_job)ã€‚

Action (æ“ä½œ): jsonb æ ¼å¼ï¼Œç”¨äºä¸‹å‘æ§åˆ¶æŒ‡ä»¤ (å¦‚: start_job)ã€‚

Metric (æµ‹ç‚¹): æ ‡å‡†æ•°æ®ç»“æ„ï¼Œç”¨äºé«˜é¢‘æ—¶åºæ•°æ® (å¦‚: cycle_time)ã€‚

3. åŠŸèƒ½éœ€æ±‚

3.1 å…¨å±€é…ç½® (Configuration)

BaseURL é…ç½®: å‰ç«¯å¿…é¡»æ”¯æŒè¿è¡Œæ—¶æˆ–æ„å»ºæ—¶é…ç½® BaseURLï¼Œä»¥ä¾¿é€šè¿‡ Kong ç½‘å…³æˆ– Nginx ä»£ç†è®¿é—® MQTT/HTTP èµ„æºã€‚

éœ€æå–é…ç½®æ–‡ä»¶æˆ–ç¯å¢ƒå˜é‡ (e.g., VITE_MQTT_HOST, VITE_API_BASE_URL)ã€‚

3.2 æ¨¡å—ä¸€ï¼šå®æ—¶æ•°æ®çœ‹æ¿ (Dashboard)

ç›®æ ‡: è®¢é˜… MQTT Topicï¼Œå®æ—¶å±•ç¤ºäº§çº¿è®¾å¤‡çš„è¿è¡ŒçŠ¶æ€å’Œå…³é”®æŒ‡æ ‡ã€‚

é¡µé¢å…ƒç´ è¦æ±‚:

è®¾å¤‡ä¿¡æ¯: æ˜¾ç¤ºå½“å‰å±‚çº§ä¿¡æ¯ (Plant: Plant_Name -> Device: Printer01)ã€‚

çŠ¶æ€å¡ç‰‡ (State - jsonb):

è®¢é˜… Topic: v1/Plant_Name/SMT-Area-1/SMT-Line-1/Printer-Cell/Printer01/State/current_job

å±•ç¤ºå­—æ®µ: Job ID, Product ID, è®¡åˆ’æ•°é‡, å®Œæˆæ•°é‡, çŠ¶æ€ç ã€‚

UI: å½“ alarm_status (å¦ä¸ª State topic) æœ‰æŠ¥è­¦æ—¶ï¼Œéœ€é«˜äº®æ˜¾ç¤ºã€‚

æŒ‡æ ‡å›¾è¡¨ (Metric):

è®¢é˜… Topic: v1/Plant_Name/SMT-Area-1/SMT-Line-1/Printer-Cell/Printer01/Metric/board_cycle_time

å±•ç¤ºæ–¹å¼: å®æ—¶æ•°å­—è·³åŠ¨æˆ–ç®€å•çš„å®æ—¶è¶‹åŠ¿å›¾ (Line Chart)ã€‚

é¢å¤–å±•ç¤º: boards_count (è‰¯å“/ä¸è‰¯å“æ•°)ã€‚

3.3 æ¨¡å—äºŒï¼šæŠ¥å·¥å·¥å•å½•å…¥ (Job Entry / Simulation)

ç›®æ ‡: æ¨¡æ‹Ÿäº§çº¿å·¥äººçš„æ“ä½œé¢æ¿ï¼Œé€šè¿‡å‘å¸ƒ MQTT æ¶ˆæ¯è§¦å‘ç”Ÿäº§åŠ¨ä½œã€‚

äº¤äº’æµç¨‹:

è¡¨å•å½•å…¥:

å­—æ®µ: Job ID (å·¥å•å·), Product ID (äº§å“å·), Planned Quantity (è®¡åˆ’æ•°)ã€‚

æ“ä½œæŒ‰é’®:

å¼€å§‹ä»»åŠ¡ (Start Job):

ç‚¹å‡»åç»„è£… JSON Payloadã€‚

Publish Topic: v1/Plant_Name/SMT-Area-1/SMT-Line-1/Printer-Cell/Printer01/Action/start_job

åœæ­¢ä»»åŠ¡ (Stop Job):

Publish Topic: v1/Plant_Name/SMT-Area-1/SMT-Line-1/Printer-Cell/Printer01/Action/stop_job

åé¦ˆ: æ“ä½œæˆåŠŸåå¼¹å‡º Toast æç¤º "æŒ‡ä»¤å·²ä¸‹å‘"ã€‚


4. æ•°æ®åè®®ä¸ Topic æ˜ å°„

åŸºäºå¯¼å…¥æ¨¡æ¿ï¼Œå‰ç«¯éœ€ç¡¬ç¼–ç æˆ–é€šè¿‡é…ç½®åŠ¨æ€ç”Ÿæˆä»¥ä¸‹ Topic è·¯å¾„ (æ³¨ï¼š... ä»£è¡¨å‰ç¼€ v1/Plant_Name/SMT-Area-1/SMT-Line-1/Printer-Cell)ï¼š

ç›‘å¬å½“å‰ä»»åŠ¡ (Sub)

Topic: .../Printer01/State/current_job

æ•°æ®æ ¼å¼: JSONB

Payload ç¤ºä¾‹: {"job_id": 101, "status": 1, ...}

ç›‘å¬æŠ¥è­¦çŠ¶æ€ (Sub)

Topic: .../Printer01/State/alarm_status

æ•°æ®æ ¼å¼: JSONB

Payload ç¤ºä¾‹: {"code": "E01", "msg": "Jam"}

ç›‘å¬å‘¨æœŸæ—¶é—´ (Sub)

Topic: .../Printer01/Metric/board_cycle_time

æ•°æ®æ ¼å¼: JSON

Payload ç¤ºä¾‹: {"cycle_time_ms": 1200, "ts": ...}

å¼€å§‹ä»»åŠ¡ (Pub)

Topic: .../Printer01/Action/start_job

æ•°æ®æ ¼å¼: JSONB

Payload ç¤ºä¾‹: {"job_id": 102, "product_id": 555}

åœæ­¢ä»»åŠ¡ (Pub)

Topic: .../Printer01/Action/stop_job

æ•°æ®æ ¼å¼: JSONB

Payload ç¤ºä¾‹: {"job_id": 102, "reason": "finish"}


5. DevOps ä¸ äº¤ä»˜è¦æ±‚

é¡¹ç›®å¿…é¡»åŒ…å« Docker æ„å»ºæ–‡ä»¶ä¸ Gitea CI/CD æµç¨‹æ–‡ä»¶ã€‚

5.1 Dockerfile

ä½äºé¡¹ç›®æ ¹ç›®å½•ï¼Œä½¿ç”¨å¤šé˜¶æ®µæ„å»ºä»¥ä¼˜åŒ–é•œåƒä½“ç§¯ã€‚

# ç¬¬ä¸€é˜¶æ®µï¼šæ„å»ºé˜¶æ®µ
FROM node:22-alpine AS builder

WORKDIR /app

# 1. å¤åˆ¶åŒ…ç®¡ç†æ–‡ä»¶å¹¶å®‰è£…ä¾èµ–
COPY package.json pnpm-lock.yaml* ./
RUN npm install -g pnpm && \
    pnpm install

# 2. å¤åˆ¶æºä»£ç å¹¶æ„å»º
COPY . .
RUN pnpm run build

# ç¬¬äºŒé˜¶æ®µï¼šè¿è¡Œé˜¶æ®µ
FROM node:22-alpine AS runner

WORKDIR /app

# 3. å…¨å±€å®‰è£…ä¸€ä¸ªè½»é‡çš„é™æ€æœåŠ¡å™¨
RUN npm install -g serve

# 4. ä»æ„å»ºé˜¶æ®µåªå¤åˆ¶æœ€ç»ˆçš„æ„å»ºäº§ç‰©
COPY --from=builder /app/dist ./dist

EXPOSE 3000

# 5. å¯åŠ¨æœåŠ¡
CMD ["serve", "-s", "dist", "-l", "3000"]


5.2 Gitea Actions Workflow

ä½äº .gitea/workflows/build.yamlã€‚å½“ä»£ç  Push åˆ°ä»“åº“æ—¶ï¼Œè‡ªåŠ¨æ„å»º Docker é•œåƒå¹¶æ¸…ç†ç¯å¢ƒã€‚

name: Gitea Actions Build
run-name: ${{ gitea.actor }} is building Frontend ğŸš€
on: [push]

jobs:
  Build-And-Package:
    runs-on: ubuntu-latest
    steps:
      - name: Basic Info
        run: |
          echo "ğŸ‰ Triggered by ${{ gitea.event_name }} event."
          echo "ğŸ” Branch: ${{ gitea.ref }}, Repo: ${{ gitea.repository }}."

      - name: Check out repository code
        uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          # æ„å»ºé•œåƒï¼Œä½¿ç”¨ä»“åº“åä½œä¸ºé•œåƒå
          docker build -t ${{ gitea.repository }}:latest .
          # å¦‚æœéœ€è¦æ¨é€åˆ°æœ¬åœ° Registry æˆ–æ‰“ Tagï¼Œåœ¨æ­¤å¤„æ·»åŠ é€»è¾‘
          echo "Docker image built: ${{ gitea.repository }}:latest"

      - name: Clean up
        if: always() # æ— è®ºæ„å»ºæˆåŠŸä¸å¦éƒ½å°è¯•æ¸…ç†
        run: |
          echo "ğŸ§¹ Cleaning up Docker resources..."
          docker builder prune --all --force
          # æ³¨æ„ï¼šåœ¨ç”Ÿäº§Runnerä¸Šæ…ç”¨ prune -aï¼Œå¯èƒ½ä¼šåˆ é™¤å…¶ä»–ç¼“å­˜
          docker image prune -f 
          # ç§»é™¤æ‚¬ç©ºé•œåƒ
          docker rmi $(docker images --filter "dangling=true" -q) || true

      - run: echo "ğŸ Job status: ${{ job.status }}."
